---
# We'll need vncserver, firefox
- name: refresh apt cache if more than 1 hour
  apt:
    update_cache: yes
    cache_valid_time: 3600
    name: [fluxbox, vnc4server, firefox, expect]
    state: latest
- name: ensure project user vnc directory exists
  file:
    path: "/home/{{cops_drupal_vars.user}}/.vnc"
    state: directory
    owner: "{{cops_drupal_vars.user}}"
    group: "{{cops_drupal_vars.group}}"
    mode: 0750
- name: Download Selenium standalone server
  get_url:
    url: "http://selenium-release.storage.googleapis.com/2.52/selenium-server-standalone-2.52.0.jar"
    owner: "{{cops_drupal_vars.user}}"
    group: "{{cops_drupal_vars.group}}"
    mode: "750"
    checksum: "sha256:09c1e8376fa70640e0038cdf3ef58c37965181567e5afd880935b64f9223e0ab"
    dest: "/home/{{cops_drupal_vars.user}}/selenium-server-standalone-2.52.0.jar"
- name: Vnc startup script launching selenium
  file:
    path: "/home/{{ cops_drupal_vars.user }}/.vnc"
    state: directory
- name: Vnc startup script launching selenium
  copy:
    dest: "/home/{{ cops_drupal_vars.user }}/.vnc/xstartup"
    content: |
        #!/bin/sh
        [ -x /etc/vnc/xstartup ] && exec /etc/vnc/xstartup
        [ -r $HOME/.Xresources ] && xrdb $HOME/.Xresources
        xsetroot -solid grey
        vncconfig -iconic &
        x-terminal-emulator -geometry 80x24+10+10 -ls -title "$VNCDESKTOP Desktop" &
        /usr/bin/startfluxbox &
        java -jar selenium-server-standalone-2.52.0.jar &
    owner: "{{ cops_drupal_vars.user }}"
    group: "{{ cops_drupal_vars.group }}"
    mode: "0750"
- become: true
  become_user: "{{ cops_drupal_vars.user }}"
  shell: |
      echo "default" | vncpasswd -f /home/{{ cops_drupal_vars.user }}/.vnc/passwd
      /usr/bin/expect <<EOF
      spawn /usr/bin/vncpasswd
      expect "Password:"
      send "{{ cops_drupal_vars.vncpasswd }}\n"
      expect "Verify:"
      send "{{ cops_drupal_vars.vncpasswd }}\n"
      expect eof
      exit
      EOF
      vncserver :1 -localhost
      vncserver -kill :1
